#!/usr/bin/env node

/**
 * Test script for Notion MCP Server
 * Tests the HTTP transport mode with Notion API credentials
 */

import fetch from 'node-fetch';

const SERVER_URL = 'http://localhost:3000';
const NOTION_TOKEN = process.env.NOTION_TOKEN || 'ntn_your_token_here';

// We'll need to get the auth token from the server first
// For testing, we'll use a known token or get it from the server startup

async function testHealthEndpoint() {
  console.log('ğŸ” Testing health endpoint...');
  try {
    const response = await fetch(`${SERVER_URL}/health`);
    const data = await response.json();
    console.log('âœ… Health check:', data);
    return true;
  } catch (error) {
    console.error('âŒ Health check failed:', error.message);
    return false;
  }
}

async function testMCPInitialize(authToken) {
  console.log('\nğŸ” Testing MCP initialize...');
  try {
    const response = await fetch(`${SERVER_URL}/mcp`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        method: 'initialize',
        params: {
          protocolVersion: '2024-11-05',
          capabilities: {},
          clientInfo: {
            name: 'test-client',
            version: '1.0.0'
          }
        },
        id: 1
      })
    });

    const data = await response.json();
    console.log('âœ… Initialize response:', JSON.stringify(data, null, 2));
    
    // Extract session ID from response headers or response
    const sessionId = response.headers.get('mcp-session-id') || data.result?.sessionId;
    return { success: true, sessionId, data };
  } catch (error) {
    console.error('âŒ Initialize failed:', error.message);
    return { success: false, error: error.message };
  }
}

async function testMCPTools(sessionId, authToken) {
  console.log('\nğŸ” Testing MCP tools list...');
  try {
    const response = await fetch(`${SERVER_URL}/mcp`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json',
        'mcp-session-id': sessionId
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        method: 'tools/list',
        params: {},
        id: 2
      })
    });

    const data = await response.json();
    console.log('âœ… Tools list response:', JSON.stringify(data, null, 2));
    return { success: true, data };
  } catch (error) {
    console.error('âŒ Tools list failed:', error.message);
    return { success: false, error: error.message };
  }
}

async function main() {
  console.log('ğŸš€ Starting MCP Server Test\n');
  console.log(`Server URL: ${SERVER_URL}`);
  console.log(`Notion Token: ${NOTION_TOKEN.substring(0, 20)}...\n`);

  // Test health endpoint (no auth required)
  const healthOk = await testHealthEndpoint();
  if (!healthOk) {
    console.error('\nâŒ Server is not running or not accessible');
    console.log('ğŸ’¡ Make sure the server is started with:');
    console.log(`   NOTION_TOKEN="${NOTION_TOKEN}" npm run dev -- --transport http --port 3000`);
    process.exit(1);
  }

  // For testing, we need to get the auth token
  // The server generates one if not provided
  // Let's try with a test token first, or we need to check server logs
  console.log('\nâš ï¸  Note: You need to provide the auth token that was generated by the server.');
  console.log('   Check the server logs for: "Generated auth token: ..."');
  console.log('   Or start the server with: --auth-token test-token');
  
  // Try with a test token (if server was started with one)
  const testAuthToken = process.env.AUTH_TOKEN || 'test-token-12345';
  console.log(`\nğŸ”‘ Using auth token: ${testAuthToken.substring(0, 15)}...`);

  // Test initialize
  const initResult = await testMCPInitialize(testAuthToken);
  if (!initResult.success) {
    console.error('\nâŒ Failed to initialize MCP session');
    console.log('ğŸ’¡ Make sure the auth token matches the one used to start the server');
    process.exit(1);
  }

  const sessionId = initResult.sessionId;
  if (!sessionId) {
    console.warn('âš ï¸  No session ID returned, trying to continue...');
  }

  // Test tools list
  if (sessionId) {
    await testMCPTools(sessionId, testAuthToken);
  }

  console.log('\nâœ… Test completed!');
}

main().catch(error => {
  console.error('âŒ Test failed:', error);
  process.exit(1);
});

